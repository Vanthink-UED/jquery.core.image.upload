!function(factory){"use strict";"function"==typeof define&&define.amd?define(["jquery"],factory):factory(window.jQuery)}(function($){"use strict";function Plugin(element,options){this.$el=$(element),this.options=$.extend({},$.fn[pluginName].defaults,options),this.init()}var pluginName="coreImageUpload",ImageBox=function(files,options,func){if(this.image={file:files},this.options=options,this.uploadAction=func,files){var reader=new FileReader,self=this;reader.onload=function(e){self.image.src=e.target.result,self.show()},reader.readAsDataURL(files[0])}this.dialog=$('<div class="g-core-image-corp-container"></div>'),this.imageAside=$('<div class="image-aside"></div>'),this.infoAside=$('<div class="info-aside"></div>')};ImageBox.prototype={show:function(){this.dialog.append(this.imageAside,this.infoAside),$("body").append(this.dialog),this._initButtons(),this._initCropBox(),this._bind()},hide:function(){this.dialog.remove()},initPic:function($container){var pic=new Image;pic.src=this.image.src,pic.onload=function(){console.log(pic.naturalWidth),this.image.width=pic.naturalWidth,this.image.height=pic.naturalHeight,this.reseyLayout(pic,$container),this.showCropBox($container,"create")}.bind(this)},reseyLayout:function(image,$container){var H=window.innerHeight-80,W=window.innerWidth-60;console.log(this.image.width);var imageWidth=this.image.width,imageHeight=this.image.height,R=imageWidth/imageHeight,Rs=W/H;R>Rs?($(image).css({width:W,height:W/R}),$container&&$container.css({width:W,height:W/R,"margin-top":(H-W/R)/2})):($(image).css({width:H*R,height:H}),$container&&$container.css({width:H*R,height:H,"margin-left":(W-H*R)/2})),$container?$container.append(image):this.imageAside.append(image),this.options.imgChangeRatio=imageWidth/image.width},_bind:function(){var self=this;this.btnUpload.on("click",function(e){self.doCropEvent(e)}),this.btnCancel.on("click",function(){self.dialog.remove()})},_initButtons:function(){this.btnUpload=$('<button type="button" class="btn btn-upload">确定</button>'),this.btnCancel=$('<button type="button" class="btn btn-cancel">取消</button>');var $btnGroup=$('<p class="btn-groups"></p>');$btnGroup.append(this.btnUpload,this.btnCancel),this.infoAside.append($btnGroup)},setNotice:function(result){this.notice=$('<div class="notice-info">'+result.errmsg+"</div>"),this.infoAside.find("notice-info").length?this.notice.text(result.errmsg):this.infoAside.prepend(this.notice),this.response.errno&&this.notice.show,2==this.response.errno&&this.infoAside.find(".notice-info").addClass("errro")},_outputImageDetails:function(){var $table=$('<table class="image-details"></table>'),htmlStr="<tr><td>图片名称</td><td>"+this.response.data.name+"</td></tr>";htmlStr+="<tr><td>图片宽度</td><td>"+this.response.data.width+"px</td></tr>",htmlStr+="<tr><td>图片高度</td><td>"+this.response.data.height+"px</td></tr>",$table.html(htmlStr);var $configInfo=$('<div class="config-info"></div>');$configInfo.append($table),this.infoAside.append($configInfo)},_initCropBox:function(){this.imageAside.append('<div class="g-crop-image-box"><div class="g-crop-image-principal"><div></div>');var $principal=this.imageAside.find(".g-crop-image-principal");this.initPic($principal)},showCropBox:function($wrap,state){var $selectCrop=$('<div class="select-recorte"></div>');$wrap.append($selectCrop);var imageWidth=parseInt($wrap.css("width")),imageHeight=parseInt($wrap.css("height")),ratioW=this.options.cropRatio.split(":")[0],ratioH=this.options.cropRatio.split(":")[1],Swidth=imageWidth/100*80,Sheight=Swidth/ratioW*ratioH;if($selectCrop.css({width:Swidth,height:Sheight,left:(imageWidth-Swidth)/2,top:(imageHeight-Sheight)/2}),Sheight>imageHeight&&(Sheight=imageHeight/100*80,Swidth=Sheight*ratioW/ratioH,$selectCrop.css({width:Swidth,height:Sheight,left:(imageWidth-Swidth)/2,top:(imageHeight-Sheight)/2})),"create"==state){$selectCrop.resizable({containment:"parent",aspectRatio:this.options.cropRatio,minWidth:Swidth/100*10,minHeight:Sheight/100*10,resize:function(e){var ui=$(e.target);ui.css("left"),ui.css("top"),ui.width(),ui.height()}}),$selectCrop.draggable({containment:"parent",drag:function(e){var ui=$(e.target);ui.css("left"),ui.css("top"),ui.width(),ui.height()}})}},doCropEvent:function(e){var thisBtn=$(e.target);thisBtn.attr("disabled","disabled"),thisBtn.text("裁剪中...");var $selectCrop=this.dialog.find(".select-recorte"),ratioW=this.options.cropRatio.split(":")[0],ratioH=this.options.cropRatio.split(":")[1],data={};data.request="crop",data.toCropImgX=parseInt($selectCrop.css("left"))*this.options.imgChangeRatio,data.toCropImgY=parseInt($selectCrop.css("top"))*this.options.imgChangeRatio,data.toCropImgW=$selectCrop.width()*this.options.imgChangeRatio,data.toCropImgH=$selectCrop.height()*this.options.imgChangeRatio,data.maxWidth=$(".maxWidthHeight input[name='maxwidth']").val(),data.maxHeight=$(".maxWidthHeight input[name='maxheight']").val(),data.ratioW=ratioW,data.ratioH=ratioH;this.options.data=$.extend(this.options.data,data),this.uploadAction()}};var methods={clear:function(Options){},init:function(){var Options=this.options;if(""==Options.url)return alert("options.url must be defined");if(""==Options.inputOfFile)return alert("options.inputOfFile must be defined");var initUpload=function(element){element.css({cursor:"pointer",overflow:"hidden"}).addClass("g-core-image-upload-element"),element.on("dragenter",function(e){$(e.target).attr("name")==Options.inputOfFile?element.addClass("picture-dropped"):element.removeClass("picture-dropped"),e.stopPropagation(),e.preventDefault()}),$(document).on("drop dragend",function(e){element.removeClass("picture-dropped"),e.stopPropagation()}),element.on("mouseout",function(e){element.removeClass("picture-dropped"),e.stopPropagation()});var $inputHidden=$("<input type='hidden' name='"+Options.InputOfImageDirectory+"' id='"+Options.InputOfImageDirectory+"'>");$inputHidden.addClass("picture-element-image-directory"),element.append($inputHidden)};initUpload(this.$el),this.__buildForm(),Options.enableButton&&($enableButton=$("<input type='button' value='Selecionar imagem' />").button().css({"font-size":"12px","margin-top":5,"margin-left":"-0.5px"}),Elemento.after($enableButton),$enableButton.unbind("click").bind("click",function(){Elemento.find("input[name='"+Options.inputOfFile+"']:file").click()}))},__buildForm:function(){var $el=this.$el,options=this.options;$el.css("position","relative");var htmlStr='<form  method="post" enctype="multipart/form-data" action="'+options.url+'">';htmlStr+='<input name="'+options.inputOfFile+'" type="file" accept="image/*" />';var dataArr=[];if("object"==typeof options.data)for(var key in options.data){var str='<input type="hidden" name='+key+'> value="'+data[key]+'"';dataArr.push(str)}htmlStr+=dataArr.join("")+"</form>";var $form=$(htmlStr),$inputUpload=$form.find('input[type="file"]');$form.css("display","none"),$form.css({cursor:"pointer",display:"block",position:"absolute",left:0,top:0,width:$el.width()<=0?132:$el.width()+30,height:$el.height()<=0?32:$el.height(),cursor:"hand",opacity:0,overflow:"hidden"});var self=this;$inputUpload.on("change",function(e){var fileVal=$inputUpload.val().replace(/C:\\fakepath\\/i,""),fileExt=fileVal.substring(fileVal.lastIndexOf(".")+1);if(options.extensions.length>1){var reg=new RegExp("^["+options.extensions.join("|")+"]+$","i");if(!reg.test(fileExt))return options.extensionError()}if(e.target.files[0].size>options.maxFileSize){var formatSize;return formatSize=parseInt(options.maxFileSize/1024/1024)>0?(options.maxFileSize/1024/1024).toFixed(2)+"MB":parseInt(options.maxFileSize/1024)>0?(options.maxFileSize/1024).toFixed(2)+"kB":options.maxFileSize.toFixed(2)+"Byte",void options.maximumSizeError}return options.files=e.target.files,options.enableCrop?void(self.imageBoxObj=new ImageBox(e.target.files,options,function(){self.tryAjaxUpload($form)})):(options.isAjax&&self.tryAjaxUpload($form),void $form.find("input[type=file]").attr("disabled","disabled"))}),$el.append($form)},tryAjaxUpload:function(form){var self=this,data=new FormData;$.each(this.options.files,function(key,value){data.append(self.options.inputOfFile,value)}),"object"==typeof self.options.data&&$.each(this.options.data,function(key,value){data.append(key,value)}),$.ajax({url:this.options.url,type:"POST",data:data,cache:!1,dataType:"json",processData:!1,contentType:!1,success:function(data){form.find("input[type=file]").removeAttr("disabled"),self.options.enableCrop&&(self.imageBoxObj.hide(),self.imageBoxObj=null),self.options.uploadedCallback(data)},error:function(jqXHR,textStatus,errorThrown){console.error("ERRORS: "+textStatus)}})},tryIframeUpload:function(form){f||(f=$('<iframe id="core-image-upload-iframe" name="core-image-upload-iframe"></iframe>').attr("style",'style="width:0px;height:0px;border:0px solid #fff;"').hide(),f.attr("src",""),$(document.body).append(f));var g=function(){form.find("input[type=file]").removeAttr("disabled");a(this).contents().find("html body").text();form.get(0).reset(),this.options.uploadedCallback(data),f.unbind()};form.submit(function(e){f.load(g),form.attr("target","core-image-upload-iframe"),e.stopPropagation()})}};Plugin.prototype=methods,$.fn[pluginName]=function(option,param){return this.each(function(){var $this=$(this),data=$this.data(pluginName),options="object"==typeof option&&option;data||$this.data(pluginName,data=new Plugin(this,options)),"string"==typeof option&&data[option](param)})},$.fn[pluginName].defaults={extensions:["jpg","jpeg","gif","bmp","png"],extensionError:function(){},url:"",inputOfFile:"",onSubmit:function(){},data:{},isAjax:!0,maximumSize:1024,enableMaximumSize:!1,MaximumSizeError:function(){},enableCrop:!1,enableResize:!0,minimumWidthToResize:1024,minimumHeightToResize:630,enableButton:!1,cropRatio:"16:9",imgChangeRatio:"",uploadedCallback:function(response){}}});